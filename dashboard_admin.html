<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de bord - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, addDoc, doc, getDoc, serverTimestamp, updateDoc, setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAsrhgqkAIKaTUg6cYjfI_39LhRii4RHY4",
      authDomain: "peluchestorecam-5f62b.firebaseapp.com",
      projectId: "peluchestorecam-5f62b",
      storageBucket: "peluchestorecam-5f62b.appspot.com",
      messagingSenderId: "137938371885",
      appId: "1:137938371885:web:6559d41f577d8544e9bfa4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let piechartInstance = null;
    const auth = getAuth(app); // Initialisation de auth ici
    let revenusDepensesChartInstance = null;
    let detteEvolutionChartInstance = null;
    let chartInstance = null;
    let dettes = []; // Pour stocker les dettes
    let capitalEntreprise = 0; // Pour stocker le capital
    
  async function loadDettes() {
    console.log("loadDettes() called");
    const snap = await getDocs(collection(db, "dettes"));
    console.log("loadDettes() - getDocs snap:", snap);
    dettes = [];
    const dettesTableBody = document.getElementById("dettesTableBody");
    dettesTableBody.innerHTML = "";
    snap.forEach(doc => {
      const dette = { id: doc.id, ...doc.data() };
      dettes.push(dette);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${dette.nom}</td>
        <td>${dette.montant} FCFA</td>
        <td><button onclick="supprimerDette('${dette.id}')">Supprimer</button></td>
      `;
      dettesTableBody.appendChild(row);
    });
    console.log("loadDettes() - dettes:", dettes);
    await updateFinanceSummary();
    console.log("loadDettes() finished");
  }
  async function supprimerDette(id) {
    if (confirm("√ätes-vous s√ªr de vouloir supprimer cette dette ?")) {
        try {
            await deleteDoc(doc(db, "dettes", id));
            await loadDettes(); // Recharge la liste apr√®s la suppression
            alert("Dette supprim√©e avec succ√®s.");
        } catch (error) {
            console.error("Erreur lors de la suppression de la dette : ", error);
            alert("Erreur lors de la suppression de la dette.");
        }
    }
}
window.supprimerDette = supprimerDette;

  async function addDette(nom, montant) {
    console.log("addDettes() called with nom:", nom, "montant:", montant);
    try {
      await addDoc(collection(db, "dettes"), { 
        nom: nom.trim(), 
        montant: parseInt(montant),
        date: serverTimestamp()
       });
      await loadDettes();
      return true;
    } catch (error) {
      console.error("Erreur lors de l'ajout de la dette : ", error);
      return false;
    }
  }
  async function loadCapital() {
    const docRef = doc(db, "finance", "capital"); // Assurez-vous d'avoir un document 'capital' dans la collection 'finance'
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      capitalEntreprise = docSnap.data().montant || 0;
      document.getElementById("montantCapital").value = capitalEntreprise;
      updateFinanceSummary();
    } else {
      // Si le document n'existe pas, initialiser √† 0
      capitalEntreprise = 0;
      document.getElementById("montantCapital").value = capitalEntreprise;
      await setDoc(docRef, { montant: 0 });
      updateFinanceSummary();
    }
  }
  async function updateCapital(montant) {
    try {
      const docRef = doc(db, "finance", "capital");
      await updateDoc(docRef, { montant: parseInt(montant) });
      capitalEntreprise = parseInt(montant);
      updateFinanceSummary();
      return true;
    } catch (error) {
      console.error("Erreur lors de la mise √† jour du capital : ", error);
      return false;
    }
  }
  async function updateFinanceSummary() {
    const revenuTotalElement = document.getElementById("revenuTotal");
    const depenseTotalElement = document.getElementById("depenseTotal");
    const totalCaisseElement = document.getElementById("totalCaisse");
    const detteTotaleElement = document.getElementById("detteTotale");
    let revenu = 0;
    const mouvementsSnap = await getDocs(collection(db, "mouvements_stock"));
    const peluches = await loadPeluches();
    mouvementsSnap.forEach(doc => {
      const data = doc.data();
      if (data.type === "sortie") {
        const peluche = peluches.find(p => p.id === data.id_peluche);
        if (peluche && peluche.prix) {
          revenu += peluche.prix * data.quantite;
        }
      }
    });
    let depense = 0;
    const depensesSnap = await getDocs(collection(db, "depenses"));
    depensesSnap.forEach(doc => {
      const data = doc.data();
      depense += data.montant;
    });
    const detteTotalMontant = dettes.reduce((sum, dette) => sum + dette.montant, 0);
    const totalCaisse = (capitalEntreprise + revenu) - depense;
    const detteTotaleCalculee = detteTotalMontant - totalCaisse;
    revenuTotalElement.textContent = `${revenu} FCFA`;
    depenseTotalElement.textContent = `${depense} FCFA`;
    totalCaisseElement.textContent = `${totalCaisse} FCFA`;
    detteTotaleElement.textContent = `${detteTotaleCalculee} FCFA`;
    loadRevenusDepensesChart();
    loadDetteEvolutionChart();

    // Calcul du revenu estim√© bas√© sur le stock
let revenuEstime = 0;
const stockSnap = await getDocs(collection(db, "stock"));
stockSnap.forEach(doc => {
  const data = doc.data();
  const peluche = peluches.find(p => p.id === data.id_peluche);
  if (peluche && peluche.prix) {
    revenuEstime += peluche.prix * data.quantite;
  }
});

// Afficher le revenu estim√©
const revenuEstimeElement = document.getElementById("revenuEstime");
revenuEstimeElement.textContent = `${revenuEstime} FCFA`;

  }

  async function loadRevenusDepensesChart() {
    const revenusParMois = {};
    const depensesParMois = {};
    const mouvementsSnap = await getDocs(collection(db, "mouvements_stock"));
    const depensesSnap = await getDocs(collection(db, "depenses"));
    const peluches = await loadPeluches();

    mouvementsSnap.forEach(doc => {
      const data = doc.data();
      if (data.type === "sortie" && data.date && data.date.toDate) {
        const date = new Date(data.date.toDate());
        const moisAnnee = `${date.getFullYear()}-${date.getMonth() + 1}`;
        const peluche = peluches.find(p => p.id === data.id_peluche);
        if (peluche && peluche.prix) {
          revenusParMois[moisAnnee] = (revenusParMois[moisAnnee] || 0) + peluche.prix * data.quantite;
        }
      }
    });

    depensesSnap.forEach(doc => {
      const data = doc.data();
      if (data.date && data.date.toDate) {
        const date = new Date(data.date.toDate());
        const moisAnnee = `${date.getFullYear()}-${date.getMonth() + 1}`;
        depensesParMois[moisAnnee] = (depensesParMois[moisAnnee] || 0) + data.montant;
      }
    });

    const mois = Object.keys(revenusParMois).concat(Object.keys(depensesParMois)).filter((v, i, a) => a.indexOf(v) === i).sort();
    const revenuData = mois.map(m => revenusParMois[m] || 0);
    const depenseData = mois.map(m => depensesParMois[m] || 0);
    const ctx = document.getElementById('revenusDepensesChart').getContext('2d');

    // V√©rifiez si une instance existe et d√©truisez-la
    if (revenusDepensesChartInstance) {
      revenusDepensesChartInstance.destroy();
    }

    revenusDepensesChartInstance = new Chart(ctx, { // Cr√©ez une nouvelle instance et stockez-la
      type: 'line',
      data: {
        labels: mois,
        datasets: [{
          label: 'Revenus',
          data: revenuData,
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false
        }, {
          label: 'D√©penses',
          data: depenseData,
          borderColor: 'rgba(255, 99, 132, 1)',
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Montant (FCFA)'
            }
          }
        }
      }
    });
  }
  async function loadDetteEvolutionChart() {
    const detteEvolution = {};
    const snap = await getDocs(query(collection(db, "dettes"), orderBy("date", "asc"))); // Si vous ajoutez un champ 'date' aux dettes
    // Si vous n'avez pas de champ 'date' pour les dettes, vous devrez peut-√™tre adapter cette logique
    snap.forEach(doc => {
      const data = doc.data();
      if (data.date && data.date.toDate) {
        const date = new Date(data.date.toDate());
        const moisAnnee = `${date.getFullYear()}-${date.getMonth() + 1}`;
        detteEvolution[moisAnnee] = (detteEvolution[moisAnnee] || 0) + data.montant;
      } else {
        // Si pas de date, vous pouvez simplement additionner toutes les dettes pour l'instant
        const totalDette = dettes.reduce((sum, dette) => sum + dette.montant, 0);
        detteEvolution["Total"] = totalDette;
      }
    });
    const labels = Object.keys(detteEvolution).sort();
    const data = labels.map(label => detteEvolution[label]);
    const ctx = document.getElementById('detteEvolutionChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '√âvolution de la Dette',
          data: data,
          borderColor: 'rgba(255, 159, 64, 1)',
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Montant (FCFA)'
            }
          }
        }
      }
    });
  }
    async function loadPeluches() {
      const snap = await getDocs(collection(db, "peluches"));
      const peluches = [];
      snap.forEach(doc => peluches.push({ id: doc.id, ...doc.data() }));
      return peluches;
    }
    async function loadStockData() {
      const stockSnap = await getDocs(collection(db, "stock"));
      const peluches = await loadPeluches();
      const stockTable = document.getElementById("stockTableBody");
      stockTable.innerHTML = "";
      const grouped = {};
      stockSnap.forEach(doc => {
        const { id_peluche, quantite } = doc.data();
        const peluche = peluches.find(p => p.id === id_peluche);
        if (!peluche) return;
        const key = `${peluche.taille}cm - ${peluche.couleur}`;
        grouped[key] = (grouped[key] || 0) + quantite;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${peluche.taille}cm</td>
          <td>${peluche.couleur}</td>
          <td>${quantite}</td>
        `;
        stockTable.appendChild(row);
      });
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: 'Stock par taille/couleur',
            data: Object.values(grouped),
            backgroundColor: Object.keys(grouped).map(() => `hsl(${Math.random() * 360}, 70%, 60%)`)
          }]
        },
        options: { responsive: true }
      });
    }
    async function populatePelucheSelect() {
      const pelucheSelect = document.getElementById("peluche");
      pelucheSelect.innerHTML = '<option value="">-- Choisir --</option>';
      const snap = await getDocs(collection(db, "peluches"));
      snap.forEach(doc => {
        const data = doc.data();
        const label = `${data.taille}cm - ${data.couleur}`;
        pelucheSelect.innerHTML += `<option value="${doc.id}">${label}</option>`;
      });
    }
    async function loadLivraisonsEnAttente() {
  const q = query(collection(db, "sorties_en_attente"));
  const snap = await getDocs(q);
  const peluches = await loadPeluches();
  const tbody = document.getElementById("livraisonsAttenteTableBody");
  tbody.innerHTML = "";

  // üîÅ Charger les utilisateurs
  const utilisateursSnap = await getDocs(collection(db, "utilisateurs"));
  const utilisateursMap = {};
  utilisateursSnap.forEach(doc => {
    const data = doc.data();
    utilisateursMap[doc.id] = data.nom || "Inconnu";
  });

  snap.forEach(doc => {
    const data = doc.data();
    if (data.valide === false) {
      const peluche = peluches.find(p => p.id === data.id_peluche);
      const dateStr = data.date?.toDate ? new Date(data.date.toDate()).toLocaleString() : "";

      // üë§ R√©cup√©ration du nom depuis la map
      const nomUtilisateur = utilisateursMap[data.effectu√©_par] || data.effectu√©_par || "?";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.taille || peluche?.taille || "?"} cm</td>
        <td>${data.couleur || peluche?.couleur || "?"}</td>
        <td>${data.quantite}</td>
        <td>${dateStr}</td>
        <td>${nomUtilisateur}</td>
      `;
      tbody.appendChild(row);
    }
  });
}



    async function loadMouvements() {
  const q = query(collection(db, "mouvements_stock"), orderBy("date", "desc"));
  const snap = await getDocs(q);
  const peluches = await loadPeluches();

  const utilisateursSnap = await getDocs(collection(db, "utilisateurs"));
  const utilisateursMap = {};
  utilisateursSnap.forEach(doc => {
    const data = doc.data();
    utilisateursMap[doc.id] = data.nom || "Inconnu";
  });

  const table = document.getElementById("mouvementsTableBody");
  table.innerHTML = "";
  const csvRows = [["Type", "Taille", "Couleur", "Quantit√©", "Effectu√© par", "Date"]];

  snap.forEach(doc => {
    const m = doc.data();
    const peluche = peluches.find(p => p.id === m.id_peluche);
    if (!peluche) return;
    const dateStr = m.date?.toDate ? new Date(m.date.toDate()).toLocaleString() : "";
    const nomUtilisateur = utilisateursMap[m.effectu√©_par] || m.effectu√©_par || "?";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.type}</td>
      <td>${peluche.taille}cm</td>
      <td>${peluche.couleur}</td>
      <td>${m.quantite}</td>
      <td>${nomUtilisateur}</td>
      <td>${dateStr}</td>
      <td><button onclick="supprimerMouvement('${doc.id}', '${m.id_peluche}', ${m.quantite}, '${m.type}')">Supprimer</button></td> `;
    table.appendChild(row);
    csvRows.push([m.type, peluche.taille + "cm", peluche.couleur, m.quantite, nomUtilisateur, dateStr]);
  });

  document.getElementById("exportCsv").onclick = () => {
    const csvContent = csvRows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mouvements_stock.csv";
    a.click();
  };
}

async function supprimerMouvement(mouvementId, pelucheId, quantite, typeMouvement) {
  if (confirm("√ätes-vous s√ªr de vouloir supprimer ce mouvement ?")) {
    try {
      // 1. Supprimer le mouvement de la collection "mouvements_stock"
      await deleteDoc(doc(db, "mouvements_stock", mouvementId));

      // 2. Mettre √† jour le stock en fonction du type de mouvement
      const stockRef = doc(db, "stock", pelucheId);
      const stockSnap = await getDoc(stockRef);

      if (stockSnap.exists()) {
        const currentStock = stockSnap.data().quantite;
        let newStock = currentStock;

        if (typeMouvement === "entree") {
          // Si c'√©tait une entr√©e, on retire la quantit√© du stock
          newStock -= quantite;
        } else if (typeMouvement === "sortie") {
          // Si c'√©tait une sortie, on ajoute la quantit√© au stock
          newStock += quantite;
        }

        if (newStock < 0) {
            console.warn("Le stock r√©sultant de la suppression est n√©gatif. Cela peut indiquer une incoh√©rence.");
            // Vous pourriez vouloir g√©rer cela plus rigoureusement, par exemple en ne permettant pas la suppression si le stock devient n√©gatif
        }
        await updateDoc(stockRef, { quantite: newStock });
      } else {
          console.warn("Peluche non trouv√©e dans le stock lors de la suppression du mouvement. Le stock n'a pas √©t√© mis √† jour.");
      }

      alert("Mouvement supprim√© avec succ√®s et stock mis √† jour.");
      await loadMouvements(); // Recharger la liste des mouvements
      await loadStockData(); // Recharger les donn√©es du stock pour mettre √† jour le graphique
      await loadStockView(); // Recharger la vue d√©taill√©e du stock
      await updateFinanceSummary(); // Mettre √† jour le r√©sum√© financier si les mouvements affectent les revenus/d√©penses
    } catch (error) {
      console.error("Erreur lors de la suppression du mouvement : ", error);
      alert("Erreur lors de la suppression du mouvement.");
    }
  }
}

// Rendre la fonction accessible globalement
window.supprimerMouvement = supprimerMouvement;


  async function loadDepenses() {
  const snap = await getDocs(query(collection(db, "depenses"), orderBy("date", "desc")));
  const table = document.getElementById("depensesTableBody");
  table.innerHTML = "";
  const csvRows = [["Description", "Montant", "Date"]];
  snap.forEach(doc => {
    const d = doc.data();
    const dateStr = d.date?.toDate ? new Date(d.date.toDate()).toLocaleDateString() : "";
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.description}</td>
      <td>${d.montant} FCFA</td>
      <td>${dateStr}</td>
      <td><button onclick="supprimerDepense('${doc.id}')">Supprimer</button></td>;
    `;
    table.appendChild(row);
    csvRows.push([d.description, d.montant, dateStr]);
  });

  async function supprimerDepense(id) {
    if (confirm("√ätes-vous s√ªr de vouloir supprimer cette d√©pense ?")) {
        try {
            await deleteDoc(doc(db, "depenses", id));
            await loadDepenses(); // Recharge la liste
            alert("D√©pense supprim√©e avec succ√®s.");
        } catch (error) {
            console.error("Erreur lors de la suppression de la d√©pense : ", error);
            alert("Erreur lors de la suppression de la d√©pense.");
        }
    }
}
window.supprimerDepense = supprimerDepense;
  document.getElementById("exportDepensesCsv").onclick = () => {
    const csvContent = csvRows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "depenses.csv";
    a.click();
  };
}
    document.addEventListener("DOMContentLoaded", async () => {
      await populatePelucheSelect();
      await loadStockData();
      await loadMouvements();
      await loadDepenses();
      await loadDepensesChart();
      await loadStockView();
      await loadFinance();
      await afficherListePeluches();
      await loadDettes();
      await loadLivraisonsEnAttente();
    await loadCapital();
    await updateFinanceSummary(); // Appeler apr√®s le chargement initial
    document.getElementById("detteForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nom = document.getElementById("nomDette").value;
      const montant = document.getElementById("montantDette").value;
      const confirmation = document.getElementById("detteConfirmation");
      if (nom && montant) {
        const success = await addDette(nom, montant);
        if (success) {
          confirmation.textContent = "‚úî Dette ajout√©e.";
          confirmation.style.color = "green";
          e.target.reset();
        } else {
          confirmation.textContent = "‚ùå Erreur lors de l'ajout de la dette.";
          confirmation.style.color = "red";
        }
      } else {
        confirmation.textContent = "‚ö†Ô∏è Veuillez remplir tous les champs.";
        confirmation.style.color = "orange";
      }
    });
    document.getElementById("capitalForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const montant = document.getElementById("montantCapital").value;
      const confirmation = document.getElementById("capitalConfirmation");
      if (montant) {
        const success = await updateCapital(montant);
        if (success) {
          confirmation.textContent = "‚úî Capital mis √† jour.";
          confirmation.style.color = "green";
        } else {
          confirmation.textContent = "‚ùå Erreur lors de la mise √† jour du capital.";
          confirmation.style.color = "red";
        }
      } else {
        confirmation.textContent = "‚ö†Ô∏è Veuillez entrer un montant pour le capital.";
        confirmation.style.color = "orange";
      }
    });
  });
  document.getElementById("searchStock").addEventListener("input", function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#stockTableBodyView tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(filter) ? "" : "none";
  });
});
const seDeconnecterButton = document.querySelector('nav button:last-child');
if(seDeconnecterButton){
  seDeconnecterButton.addEventListener('click', seDeconnecter);
}
    const taillePelucheSelect = document.getElementById("taillePeluche");
    const couleurPeluche = document.getElementById("couleurPeluche");
    const prixPelucheInput = document.getElementById("prixPeluche");
    const prixParTaille= {
      "60": 5000,
      "80": 8000,
      "100": 15000,
      "140": 35000
    };
    taillePelucheSelect.addEventListener("change", function() {
    const tailleChoisie = this.value;
    prixPelucheInput.value = prixParTaille[tailleChoisie] || ""; // Met √† jour le prix ou vide si non trouv√©
  });
 const ajoutPelucheForm = document.getElementById("ajoutPelucheForm");
  ajoutPelucheForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const taillePelucheValue = document.getElementById("taillePeluche").value;
    const couleurPelucheValue = document.getElementById("couleurPeluche").value;
    const prixPelucheValue = document.getElementById("prixPeluche").value;
    const ajoutPelucheConfirmation = document.getElementById("ajoutPelucheConfirmation");
    if (taillePeluche && couleurPelucheValue && prixPelucheValue) {
      const ajoutReussi = await ajouterPeluche(taillePelucheValue, couleurPelucheValue, prixPelucheValue);
      if (ajoutReussi) {
        ajoutPelucheConfirmation.textContent = "‚úî Peluche ajout√©e avec succ√®s.";
        ajoutPelucheConfirmation.style.color = "green";
        ajoutPelucheForm.reset();
        await afficherListePeluches(); // Rafra√Æchir la liste
        await populatePelucheSelect(); // Mettre √† jour la liste dans le formulaire de stock
      } else {
        ajoutPelucheConfirmation.textContent = "‚ùå Erreur lors de l'ajout de la peluche.";
        ajoutPelucheConfirmation.style.color = "red";
      }
    } else {
      ajoutPelucheConfirmation.textContent = "‚ö†Ô∏è Veuillez remplir tous les champs.";
      ajoutPelucheConfirmation.style.color = "orange";
    }
  });
  document.getElementById("stockForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id_peluche = document.getElementById("peluche").value;
  const quantite = parseInt(document.getElementById("quantite").value);
  const type = document.getElementById("type").value;
  const confirmation = document.getElementById("confirmation");

  if (!id_peluche || !quantite || !type) return;

  const user = auth.currentUser;
  const uid = user ? user.uid : "admin";  // Par d√©faut "admin" si non connect√©

  const mouvement = {
    id_peluche,
    quantite,
    type,
    effectu√©_par: uid,
    date: serverTimestamp()
  };

  try {
    const stockRef = doc(db, "stock", id_peluche);
    const stockSnap = await getDoc(stockRef);
    const current = stockSnap.exists() ? stockSnap.data().quantite : 0;

    if (type === "sortie") {
      if (!stockSnap.exists() || current < quantite) {
        confirmation.textContent = "‚ùå Stock insuffisant pour la sortie.";
        confirmation.style.color = "red";
        return;
      }
      await updateDoc(stockRef, { quantite: current - quantite });
    } else {
      if (stockSnap.exists()) {
        await updateDoc(stockRef, { quantite: current + quantite });
      } else {
        await setDoc(stockRef, { id_peluche, quantite });
      }
    }

    await addDoc(collection(db, "mouvements_stock"), mouvement);
    confirmation.textContent = "‚úî Mouvement enregistr√© avec succ√®s";
    confirmation.style.color = "green";
    e.target.reset();
    await loadStockData();
    await loadMouvements();
  } catch (err) {
    console.error(err);
    confirmation.textContent = "‚ùå Erreur lors de l'enregistrement";
    confirmation.style.color = "red";
  }
});

      document.getElementById("depenseForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const description = document.getElementById("descDepense").value.trim();
  const montant = parseInt(document.getElementById("montantDepense").value);
  const confirmation = document.getElementById("depenseConfirmation");
  if (!description || !montant) return;
  try {
    await addDoc(collection(db, "depenses"), {
      description,
      montant,
      date: serverTimestamp()
    });
    confirmation.textContent = "‚úî D√©pense enregistr√©e";
    confirmation.style.color = "green";
    e.target.reset();
    await loadDepenses();
  } catch (err) {
    console.error(err);
    confirmation.textContent = "‚ùå Erreur lors de l'enregistrement";
    confirmation.style.color = "red";
  }
});
    async function ajouterPeluche(taille, couleur, prix) {
  try {
    await addDoc(collection(db, "peluches"), {
      taille: parseInt(taille),
      couleur: couleur.trim(),
      prix: parseInt(prix)
    });
    return true;
  } catch (error) {
    console.error("Erreur lors de l'ajout de la peluche : ", error);
    return false;
  }
}
function seDeconnecter() {
  console.log("Fonction seDeconnecter appel√©e !");
  console.log("Objet auth : ", auth); // Ajout de cette ligne
  signOut(auth).then(() => {
    // Rediriger l'utilisateur vers la page de connexion
    window.location.href = "index.html"; // Assurez-vous d'avoir une page de connexion
    console.log("D√©connexion r√©ussie.");
  }).catch((error) => {
    console.error("Erreur lors de la d√©connexion : ", error);
    alert("Erreur lors de la d√©connexion.");
  });
}
async function afficherListePeluches() {
  const listePeluchesBody = document.getElementById("listePeluchesBody");
  listePeluchesBody.innerHTML = ""; // Effacer le contenu pr√©c√©dent
  const snap = await getDocs(collection(db, "peluches"));
  snap.forEach(doc => {
    const peluche = doc.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${peluche.taille}</td>
      <td>${peluche.couleur}</td>
      <td>${peluche.prix} FCFA</td>
    `;
    listePeluchesBody.appendChild(row);
  });}
    async function loadFinance() {
  const mouvementsSnap = await getDocs(collection(db, "mouvements_stock"));
  const depensesSnap = await getDocs(collection(db, "depenses"));
  const peluches = await loadPeluches();
  let revenu = 0;
  mouvementsSnap.forEach(doc => {
    const data = doc.data();
    if (data.type === "sortie") {
      const peluche = peluches.find(p => p.id === data.id_peluche);
      if (peluche && peluche.prix) {
        revenu += peluche.prix * data.quantite;
      }
    }
  });
  let depense = 0;
  depensesSnap.forEach(doc => {
    const data = doc.data();
    depense += data.montant;
  });
  document.getElementById("revenuTotal").textContent = `Revenu total : ${revenu - depense} FCFA`;
  document.getElementById("depenseTotal").textContent = `D√©pense totale : ${depense} FCFA`;
  
}
async function loadStockView() {
  const stockSnap = await getDocs(collection(db, "stock"));
  const peluches = await loadPeluches(); // Assurez-vous que loadPeluches() est d√©finie et fonctionne correctement
  const stockTable = document.getElementById("stockTableBodyView");
  stockTable.innerHTML = "";

  const stockData = [];

  stockSnap.forEach(doc => {
    const { id_peluche, quantite } = doc.data();
    const peluche = peluches.find(p => p.id === id_peluche);
    if (!peluche) return;

    stockData.push({
      docId: doc.id, // ID du document dans la collection 'stock' - AJOUT√â
      taille: peluche.taille,
      couleur: peluche.couleur,
      quantite: quantite
    });
  });

  // Trier par taille (nombre croissant)
  stockData.sort((a, b) => a.taille - b.taille);

  let totalQuantite = 0;

  stockData.forEach(item => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.taille}cm</td>
      <td>${item.couleur}</td>
      <td class="editable-quantity" data-stock-doc-id="${item.docId}" contenteditable="true">${item.quantite}</td> `;
    stockTable.appendChild(row);
    totalQuantite += item.quantite;
  });

  // Ajouter la ligne de total
  const totalRow = document.createElement("tr");
  totalRow.style.fontWeight = "bold";
  totalRow.style.backgroundColor = "#f0f0f0";
  totalRow.innerHTML = `
    <td colspan="2">Total</td>
    <td>${totalQuantite}</td>
  `;
  stockTable.appendChild(totalRow);

  // AJOUT√â : √âcouteurs d'√©v√©nements pour l'√©dition en ligne et la sauvegarde
  document.querySelectorAll('#stockTableBodyView .editable-quantity').forEach(cell => {
    cell.addEventListener('blur', async function() {
      const newQuantity = parseInt(this.textContent);
      const stockDocId = this.dataset.stockDocId;

      if (isNaN(newQuantity) || newQuantity < 0) {
        alert("Veuillez entrer une quantit√© valide (nombre positif).");
        // Revenir √† l'ancienne valeur si invalide
        const oldQuantity = parseInt(this.dataset.oldValue || 0); // Utiliser 0 si oldValue n'est pas d√©fini
        this.textContent = oldQuantity;
        return;
      }

      if (stockDocId) {
        try {
          const stockRef = doc(db, "stock", stockDocId);
          await updateDoc(stockRef, { quantite: newQuantity });
          alert("Quantit√© mise √† jour avec succ√®s.");
          // Mettre √† jour les autres sections du tableau de bord si n√©cessaire
          // Assurez-vous que ces fonctions sont d√©finies ailleurs dans votre script
          await updateFinanceSummary(); // Met √† jour le r√©sum√© financier (si stock impacte revenu estim√©)
          await loadStockData(); // Rafra√Æchit le graphique circulaire des peluches (si vous en avez un)
          await loadMouvements(); // Rafra√Æchit les mouvements de stock
          await loadStockView(); // Recharger la vue du stock pour s'assurer que les totaux sont √† jour

        } catch (error) {
          console.error("Erreur lors de la mise √† jour de la quantit√© : ", error);
          alert("Erreur lors de la mise √† jour de la quantit√©.");
        }
      }
    });

    // Stocker l'ancienne valeur lors de la mise au point pour une √©ventuelle r√©initialisation
    cell.addEventListener('focus', function() {
      this.dataset.oldValue = this.textContent;
    });

    // Permettre l'enregistrement sur la touche 'Entr√©e'
    cell.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Emp√™cher la nouvelle ligne
        this.blur(); // D√©clencher l'√©v√©nement blur pour enregistrer
      }
    });
  });
}

  async function loadDepensesChart() {
  const snap = await getDocs(collection(db, "depenses"));
  const depenses = {};
  snap.forEach(doc => {
    const data = doc.data();
    const type = data.description || "Autre";
    depenses[type] = (depenses[type] || 0) + data.montant;
  });
  const ctx = document.getElementById('depensesChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(depenses),
      datasets: [{
        label: 'D√©penses par type',
        data: Object.values(depenses),
        backgroundColor: 'rgba(255, 99, 132, 0.5)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    window.showSection = showSection;
  </script>
  <style>
    body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background: #f4f6f8;
  color: #333;
 }
 header {
  background: #2c3e50; /* Couleur gris fonc√© */
  color: white;
  padding: 1.5rem 0;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
 }
 .container {
  display: grid;
  grid-template-columns: 250px 1fr;
  min-height: 100vh;
 }
 nav {
  background: #34495e; /* Couleur gris un peu plus clair */
  padding: 1rem;
  color: white;
 }
 nav h2 {
  margin-top: 0;
  margin-bottom: 1.5rem;
  text-align: center;
  color: #ecf0f1;
 }
 nav button {
  width: 100%;
  padding: 0.9rem;
  margin-bottom: 0.8rem;
  border: none;
  border-radius: 6px;
  background: #3b82f6; /* Bleu plus moderne */
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-weight: bold;
 }
 nav button:hover {
  background: #2563eb;
 }
 main {
  padding: 2rem;
 }
 .section {
  display: none;
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  margin-bottom: 2rem;
 }
 .active {
  display: block;
 }
 h2 {
  color: #2c3e50;
  margin-top: 0;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.5rem;
 }
 h3 {
  color: #34495e;
  margin-top: 1.5rem;
  margin-bottom: 1rem;
 }
 form label {
  display: block;
  margin-bottom: 0.5rem;
  color: #555;
  font-weight: bold;
 }
 form select,
 form input {
  padding: 0.7rem;
  width: 100%;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-sizing: border-box;
 }
 form button[type="submit"] {
  background: #27ae60; /* Vert plus moderne */
  color: white;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s ease;
 }
 form button[type="submit"]:hover {
  background: #1e8449;
 }
 form p#ajoutPelucheConfirmation,
 form p#confirmation,
 form p#depenseConfirmation {
  margin-top: 1rem;
  font-weight: bold;
 }
 table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  border-radius: 8px;
  overflow: hidden;
 }
 table th,
 table td {
  border: 1px solid #e0e0e0;
  padding: 0.8rem;
  text-align: left;
 }
 table th {
  background: #f0f0f0;
  font-weight: bold;
  color: #333;
 }
 table tbody tr:nth-child(even) {
  background: #f9f9f9;
 }
 #exportCsv,
 #exportDepensesCsv {
  background: #f39c12; /* Orange pour l'export */
  color: white;
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 1rem;
  margin-bottom: 1rem;
  font-weight: bold;
  transition: background-color 0.3s ease;
 }
 #exportCsv:hover,
 #exportDepensesCsv:hover {
  background: #e67e22;
 }
 #searchStock {
  width: 100%;
  padding: 0.7rem;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-sizing: border-box;
 }
 /* Styles sp√©cifiques pour la section finance */
 #section-finance p {
  margin-bottom: 1rem;
  font-size: 1.1em;
  color: #555;
 }
 #revenuChart {
  max-width: 600px;
  margin: 0 auto;
 }
  </style>
</head>
<body>
  <header><h1>Tableau de bord - Admin</h1></header>
  <div class="container">
    <nav>
      <button onclick="showSection('section-dashboard')">Dashboard</button>
      <button onclick="showSection('section-stock-view')">Stock</button>
      <button onclick="showSection('section-peluches')">Peluches</button>
      <button onclick="showSection('section-stock')">Entr√©e/Sortie</button>
      <button onclick="showSection('section-livraisons')">Livraisons En Attentes</button>
      <button onclick="showSection('section-depenses')">D√©penses</button>
      <button onclick="showSection('section-finance')">Finances</button>
      <button>Se d√©connecter</button> 
    </nav>
    <main>
       <section id="section-peluches" class="section">
  <h2>Gestion des peluches</h2>
  <form id="ajoutPelucheForm">
    <label for="taillePeluche">Taille (cm) :</label>
    <select id="taillePeluche" required>
      <option value="">-- Choisir --</option>
      <option value="60">60 cm</option>
      <option value="80">80 cm</option>
      <option value="100">100 cm</option>
      <option value="140">140 cm</option>
    </select>
    <label for="couleurPeluche">Couleur :</label>
    <select id="couleurPeluche" required>
      <option value="">-- Choisir --</option>
      <option value="blanc">Blanc</option>
      <option value="rouge">Rouge</option>
      <option value="marron">Marron</option>
      <option value="violet">Violet</option>
      <option value="orange">Orange</option>
      <option value="rose">Rose</option>
    </select>
    <label for="prixPeluche">Prix (FCFA) :</label>
    <input type="number" id="prixPeluche" readonly>
    <button type="submit">Ajouter la peluche</button>
    <p id="ajoutPelucheConfirmation"></p>
  </form>
  <h3>Liste des peluches</h3>
  <table>
    <thead>
      <tr>
        <th>Taille</th>
        <th>Couleur</th>
        <th>Prix</th>
      </tr>
    </thead>
    <tbody id="listePeluchesBody"></tbody>
  </table>
</section>
      <section id="section-dashboard" class="section active">
        <h2>Stock actuel</h2>
        <canvas id="pieChart" style="max-width: 300px;"></canvas>
        <h3>D√©penses par type</h3>
        <canvas id="depensesChart" style="max-width: 400px; height: 300px;"></canvas>
        <table>
          <thead><tr><th>Taille</th><th>Couleur</th><th>Quantit√©</th></tr></thead>
          <tbody id="stockTableBody"></tbody>
        </table>
      </section>
      <section id="section-stock-view" class="section">
        <h2>Stock actuel</h2>
  <input type="text" id="searchStock" placeholder="Rechercher dans le stock...">
  <table id="stockTable" class="table">
    <thead>
      <tr>
        <th>Taille</th>
        <th>Couleur</th>
        <th>Quantit√©</th>
      </tr>
    </thead>
    <tbody id="stockTableBodyView"></tbody>
  </table>
</section>
      <section id="section-stock" class="section">
        <h2>Ajouter un mouvement</h2>
        <form id="stockForm">
          <label for="peluche">Peluche (taille / couleur) :</label>
          <select id="peluche" required></select>
          <label for="quantite">Quantit√© :</label>
          <input type="number" id="quantite" min="1" required>
          <label for="type">Type :</label>
          <select id="type" required>
            <option value="">-- Choisir --</option>
            <option value="entree">Entr√©e</option>
            <option value="sortie">Sortie</option>
          </select>
          <button type="submit">Valider</button>
          <p id="confirmation"></p>
        </form>
        <h3>Derniers mouvements</h3>
        <button id="exportCsv">üì§ Exporter CSV</button>
        <table>
          <thead><tr>
            <th>Type</th>
            <th>Taille</th>
            <th>Couleur</th>
            <th>Quantit√©</th>
            <th>Effectu√© par</th>
            <th>Date</th>
            <th>Actions</th>
          </tr></thead>
          <tbody id="mouvementsTableBody"></tbody>
        </table>
      </section>
      <section id="section-livraisons" class="section">
  <h2>Livraisons en attente</h2>
  <table>
    <thead>
      <tr>
        <th>Taille</th>
        <th>Couleur</th>
        <th>Quantit√©</th>
        <th>Date</th>
        <th>Effectu√© par</th>
      </tr>
    </thead>
    <tbody id="livraisonsAttenteTableBody"></tbody>
  </table>
</section>

      <section id="section-depenses" class="section">
  <h2>D√©penses</h2>
  <form id="depenseForm">
    <label for="descDepense">Description :</label>
    <select id="descDepense" required>
      <option value="">-- Choisir --</option>
      <option value="loyer">Loyer</option>
      <option value="connexion">Connexion</option>
      <option value="courses">Courses</option>
      <option value="salaire">Salaire</option>
      <option value="coton">Coton</option>
      <option value="transport">Transport</option>
      <option value="peluches">Achat Peluches</option>
      <option value="cotisation">Cotisation</option>
      <option value="electricite">Electricite</option>
      <option value="autre">Autre</option>
    </select>
    <label for="montantDepense">Montant (FCFA) :</label>
    <input type="number" id="montantDepense" required>
    <button type="submit">Ajouter d√©pense</button>
    <p id="depenseConfirmation"></p>
  </form>
  <h3>Historique des d√©penses</h3>
  <button id="exportDepensesCsv">üì§ Exporter CSV</button>
  <table>
    <thead><tr>
      <th>Description</th>
      <th>Montant</th>
      <th>Date</th>
      <th>Actions</th>
    </tr></thead>
    <tbody id="depensesTableBody"></tbody>
  </table>
</section>
<section id="section-finance" class="section">
  <h2>Finance</h2>
  <h3>Dettes de l'entreprise</h3>
  <form id="detteForm">
    <label for="nomDette">Nom du cr√©ancier :</label>
    <input type="text" id="nomDette" required>
    <label for="montantDette">Montant de la dette (FCFA) :</label>
    <input type="number" id="montantDette" required>
    <button type="submit">Ajouter une dette</button>
    <p id="detteConfirmation"></p>
  </form>
  <h3>Liste des dettes</h3>
  <table>
    <thead>
      <tr>
        <th>Nom du cr√©ancier</th>
        <th>Montant (FCFA)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="dettesTableBody"></tbody>
  </table>
  <h3>Capital de l'entreprise</h3>
  <form id="capitalForm">
    <label for="montantCapital">Montant du capital (FCFA) :</label>
    <input type="number" id="montantCapital" id="montantCapital" required>
    <button type="submit">Modifier le capital</button>
    <p id="capitalConfirmation"></p>
  </form>
  <h3>R√©sum√© financier</h3>
  <table>
    <tbody>
      <tr>
        <th>Revenu Estime (valeur du stock) :</th>
        <td id="revenuEstime"></td>
      </tr>
      <tr>
        <th>Revenus Totaux :</th>
        <td id="revenuTotal"></td>
      </tr>
      <tr>
        <th>D√©penses Totales :</th>
        <td id="depenseTotal"></td>
      </tr>
      <tr>
        <th>Total en Caisse :</th>
        <td id="totalCaisse"></td>
      </tr>
      <tr>
        <th>Dette Totale :</th>
        <td id="detteTotale"></td>
      </tr>
    </tbody>
  </table>
  <h3>Graphique : Revenus vs D√©penses (Mensuel)</h3>
  <canvas id="revenusDepensesChart"></canvas>
  <h3>Graphique : √âvolution de la Dette</h3>
  <canvas id="detteEvolutionChart"></canvas>
</section>
    </main>
  </div>
</body>
</html>
