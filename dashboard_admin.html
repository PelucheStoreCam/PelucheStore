<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PelucheStore - Admin Finance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --sidebar-bg: #111827;
      --primary-blue: #2563eb;
      --bg-light: #f3f7ff;
      --text-dark: #111827;
      --text-gray: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
      --finance-gold: #f59e0b;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-light); display: flex; height: 100vh; overflow: hidden; }

    nav { width: 260px; background-color: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; }
    .nav-logo { padding: 0 25px 40px; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700; color: white; }
    nav button { width: 90%; margin: 4px auto; padding: 12px 20px; border: none; background: transparent; color: #9ca3af; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 15px; border-radius: 10px; font-size: 15px; transition: 0.2s; }
    nav button i { width: 20px; font-size: 18px; }
    nav button:hover { background: #1f2937; color: white; }
    nav button.active-nav { background: var(--primary-blue); color: white; }

    .main-container { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    .top-bar { height: 70px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; position: sticky; top:0; z-index:100; }
    .search-bar { background: #f3f4f6; padding: 10px 20px; border-radius: 10px; width: 400px; display: flex; align-items: center; gap: 10px; }
    .search-bar input { border: none; background: transparent; outline: none; width: 100%; }
    .user-info { display: flex; align-items: center; gap: 15px; font-weight: 600; }

    main { padding: 0 30px 30px; }
    .welcome-card { background: white; margin: 30px 0; padding: 25px; border-radius: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    
    .stat-box { background: white; flex: 1; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #eef2f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .stat-box .count { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
    .stat-box .label { font-size: 11px; color: var(--text-gray); font-weight: 600; text-transform: uppercase; }

    .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
    .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eef2f6; }
    .chart-container h3 { margin: 0 0 15px 0; font-size: 15px; color: var(--text-dark); }
    .full-width-chart { grid-column: span 2; }

    .section { display: none; }
    .section.active { display: block; }

    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 10px; }
    .action-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eef2f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .action-card h3 { font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-gray); font-weight: 600; margin-bottom: 5px; }
    .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: inherit; }
    .btn-submit { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: 0.2s; }

    .history-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .history-table th { background: #f9fafb; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: var(--text-gray); }
    .history-table td { padding: 15px; border-top: 1px solid #f3f4f6; font-size: 14px; }
    .badge-in { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .badge-out { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    
    .btn-action { border: none; background: none; cursor: pointer; font-size: 16px; margin: 0 5px; transition: 0.2s; }
    .btn-delete { color: #ef4444; }
    .btn-print { color: #2563eb; }
    
    .inv-card { background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-blue); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    .fin-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .fin-card { padding: 20px; border-radius: 12px; color: white; }

    /* Nouveaux styles pour la finance et les alertes */
    .fin-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .fin-card { padding: 15px; border-radius: 12px; color: white; display: flex; flex-direction: column; }
    .fin-card span:first-child { font-size: 10px; text-transform: uppercase; opacity: 0.8; font-weight: 600; }
    .fin-card span:last-child { font-size: 18px; font-weight: 800; }
    .notif-alert {
        background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c;
        padding: 12px; border-radius: 8px; margin-bottom: 10px;
        display: flex; align-items: center; gap: 10px; font-size: 14px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        animation: shake 0.5s;
    }
@keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

    /* Nouveaux styles ajout√©s sans modification du reste */
    .notif-alert {
        background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c;
        padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;
        display: flex; align-items: center; gap: 10px; animation: shake 0.5s;
    }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, where, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp, increment, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsrhgqkAIKaTUg6cYjfI_39LhRii4RHY4",
      authDomain: "peluchestorecam-5f62b.firebaseapp.com",
      projectId: "peluchestorecam-5f62b",
      storageBucket: "peluchestorecam-5f62b.appspot.com",
      messagingSenderId: "137938371885",
      appId: "1:137938371885:web:6559d41f577d8544e9bfa4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let peluchesGlobal = {};
    let userName = "";

    onAuthStateChanged(auth, async (user) => {
      // √Ä mettre au d√©but de votre script ou dans onAuthStateChanged
if(document.getElementById('perf-month-picker')) {
    document.getElementById('perf-month-picker').value = new Date().toISOString().slice(0, 7);
}
      if (user) {
        const userDoc = await getDoc(doc(db, "utilisateurs", user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          userName = userData.nom || "Utilisateur";
          document.getElementById("user-name-display").textContent = userName;
          document.getElementById("welcome-name").textContent = "SALUT, " + (userName).toUpperCase();
          document.getElementById("user-photo").src = `https://ui-avatars.com/api/?name=${userData.nom}&background=2563eb&color=fff`;
          
          const pSnap = await getDocs(collection(db, "peluches"));
          pSnap.forEach(d => peluchesGlobal[d.id] = d.data());

          loadDashboardStats();
          loadActionData();
          loadHistory();
          loadInventory();
          loadFinance();
          verifierRemboursements(); // Appel de la nouvelle fonction
          loadDepenses();
          loadMonthlyPerformance();
        }
      } else { window.location.href = "index.html"; }
    });

    window.modifierQuantiteStock = async (pelucheId, quantiteActuelle, description) => {
    const nouvelleQuantite = prompt(`Modifier le stock pour : ${description}\nEntrez la nouvelle quantit√© totale :`, quantiteActuelle);
    
    if (nouvelleQuantite === null) return;
    
    const qteNum = parseInt(nouvelleQuantite);
    if (isNaN(qteNum) || qteNum < 0) {
        alert("Veuillez entrer un chiffre valide.");
        return;
    }

    try {
        const pelucheRef = doc(db, "peluches", pelucheId);
        await updateDoc(pelucheRef, { quantite: qteNum });
        alert("Stock mis √† jour !");
        loadInventory(); // Rafra√Æchit le tableau imm√©diatement
        if(typeof loadStats === 'function') loadStats(); // Rafra√Æchit le tableau de bord si n√©cessaire
    } catch (e) {
        console.error(e);
        alert("Erreur lors de la mise √† jour.");
    }
};

// Fonction pour charger les commandes re√ßues de la vitrine
async function loadCommandesVitrine() {
    const q = query(collection(db, "commandes"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    let html = "";
    let nbAttente = 0;

    snap.forEach(docC => {
        const cmd = docC.data();
        if (cmd.statut === "re√ßue") {
            nbAttente++;
            // On cherche la peluche dans notre stock local (peluchesGlobal)
            // Note: Il faudra s'assurer que l'ID envoy√© par la vitrine correspond
            const stockArticle = Object.values(peluchesGlobal).find(p => p.nom === cmd.produit);
            const stockDisponible = stockArticle ? stockArticle.quantite : 0;
            const assezDeStock = stockDisponible >= cmd.quantite;

            html += `
                <tr>
                    <td>${cmd.date?.toDate().toLocaleDateString()}</td>
                    <td>${cmd.nom} <br><small>${cmd.telephone}</small></td>
                    <td>${cmd.produit} (x${cmd.quantite})</td>
                    <td>
                        <span class="badge" style="background:${assezDeStock ? 'var(--success)' : 'var(--danger)'}">
                            ${assezDeStock ? 'Disponible: ' + stockDisponible : 'Insuffisant: ' + stockDisponible}
                        </span>
                    </td>
                    <td>
                        ${assezDeStock ? 
                            `<button onclick="validerVersLivraison('${docC.id}')" class="btn-action" style="color:var(--primary-blue)">
                                <i class="fa-solid fa-truck"></i> Valider
                             </button>` : 
                            `<button onclick="contacterClient('${cmd.telephone}', '${cmd.produit}')" class="btn-action" style="color:var(--finance-gold)">
                                <i class="fa-brands fa-whatsapp"></i> Signaler rupture
                             </button>`
                        }
                    </td>
                </tr>`;
        }
    });

    document.getElementById("commandes-vitrine-body").innerHTML = html || "<tr><td colspan='5'>Aucune nouvelle commande</td></tr>";
    
    // Mise √† jour du badge dans la barre lat√©rale
    const badge = document.getElementById("badge-commandes");
    if(nbAttente > 0) { badge.innerText = nbAttente; badge.style.display = "inline"; }
    else { badge.style.display = "none"; }
}

// Fonction pour envoyer vers "Livraison en attente"
window.validerVersLivraison = async (idCmd) => {
    try {
        const cmdRef = doc(db, "commandes", idCmd);
        await updateDoc(cmdRef, { statut: "en_attente_livraison" });
        alert("Commande transf√©r√©e √† la liste des livraisons !");
        loadCommandesVitrine();
    } catch(e) { console.error(e); }
};

// Fonction pour contacter le client en cas de rupture
window.contacterClient = (tel, produit) => {
    const msg = encodeURIComponent(`Bonjour, nous avons bien re√ßu votre commande pour la peluche ${produit}. Malheureusement, ce mod√®le est actuellement en rupture de stock. Souhaitez-vous un autre mod√®le ?`);
    window.open(`https://wa.me/${tel}?text=${msg}`, '_blank');
};

    // Fonction pour enregistrer un remboursement partiel ou total
window.gererRemboursement = async (idDette, montantActuel, nomDebiteur) => {
    const promptMontant = prompt(`Montant rembours√© par ${nomDebiteur} (FCFA) :`, "0");
    const montantRembourse = parseInt(promptMontant);

    if (isNaN(montantRembourse) || montantRembourse <= 0) {
        return; // Annulation si montant invalide
    }

    if (montantRembourse > montantActuel) {
        alert("Le montant rembours√© ne peut pas √™tre sup√©rieur √† la dette actuelle !");
        return;
    }

    try {
        // 1. Mise √† jour du Capital (On ajoute le montant rembours√© au capital actuel)
        const capRef = doc(db, "finance", "capital");
        await updateDoc(capRef, { montant: increment(montantRembourse) });

        // 2. Mise √† jour de la Dette
        const detteRef = doc(db, "nouvelles_dettes", idDette);
        const nouveauMontantDette = montantActuel - montantRembourse;

        if (nouveauMontantDette <= 0) {
            // Si la dette est totalement pay√©e, on la supprime
            await deleteDoc(detteRef);
            alert(`Dette de ${nomDebiteur} sold√©e avec succ√®s ! ${montantRembourse} FCFA ajout√©s au capital.`);
        } else {
            // Sinon on met √† jour le montant restant
            await updateDoc(detteRef, { montant: nouveauMontantDette });
            alert(`Remboursement enregistr√©. Reste √† payer : ${nouveauMontantDette} FCFA. Capital mis √† jour.`);
        }

        // 3. Recharger les donn√©es financi√®res pour voir les changements
        loadFinance();
    } catch (e) {
        console.error("Erreur remboursement:", e);
        alert("Une erreur est survenue lors de l'op√©ration.");
    }
};
    async function loadDashboardStats() {
      const now = new Date();
      const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startOfDay = new Date(now.setHours(0,0,0,0));

      const [mSnap, lSnap, sSnap] = await Promise.all([
        getDocs(collection(db, "mouvements_stock")),
        getDocs(collection(db, "livraisons")),
        getDocs(collection(db, "stock"))
      ]);

      const mvts = mSnap.docs.map(d => d.data());
      const livrs = lSnap.docs.map(d => d.data());

      let vMois = 0;
      mvts.forEach(m => {
        const dt = m.date?.toDate();
        if (m.type === "sortie" && dt >= firstDayMonth) {
          vMois += (peluchesGlobal[m.id_peluche]?.prix || 0) * m.quantite;
        }
      });

      document.getElementById("ventes-mois").textContent = vMois.toLocaleString() + " FCFA";
      document.getElementById("livr-attente").textContent = livrs.filter(l => l.statut === "en attente").length;
      document.getElementById("livr-jour").textContent = livrs.filter(l => l.statut === "livr√©" && l.date_livraison?.toDate() >= startOfDay).length;

      let tStock = 0, aStock = 0;
      sSnap.forEach(d => { 
        const q = d.data().quantite; 
        tStock += q; 
        if (q < 15) aStock++; 
      });
      document.getElementById("stock-total").textContent = tStock;
      document.getElementById("stock-alerte").textContent = aStock;

      renderCharts(mvts, livrs, peluchesGlobal);
    }

    async function loadActionData() {
      let pOptions = '<option value="">Choisir une peluche</option>';
      for (const [id, p] of Object.entries(peluchesGlobal)) {
        pOptions += `<option value="${id}">${p.taille}cm - ${p.couleur}</option>`;
      }
      document.getElementById("p-select-entree").innerHTML = pOptions;
      document.getElementById("p-select-sortie").innerHTML = pOptions;

      const lSnap = await getDocs(query(collection(db, "livraisons"), where("statut", "==", "en attente")));
      let lOptions = '<option value="">Choisir une commande</option>';
      const pendingBody = document.getElementById("pending-orders-body");
      pendingBody.innerHTML = "";

      lSnap.forEach(d => {
        const l = d.data();
        const p = peluchesGlobal[l.id_peluche];
        const produitNom = p ? `${p.taille}cm ${p.couleur}` : "Inconnu";

        lOptions += `<option value="${d.id}">${l.client} (${l.quartier || 'Aucune loc.'})</option>`;
        
        pendingBody.innerHTML += `
          <tr>
            <td><strong>${l.client}</strong><br><small>${l.telephone}</small></td>
            <td>${produitNom}</td>
            <td>${l.quantite}</td>
            <td>${l.quartier || '-'}</td>
            <td>${l.mode_paiement}</td>
            <td>
              <button onclick="validerLivrSpecifique('${d.id}')" class="btn-action" style="color:var(--success)" title="Livrer"><i class="fa-solid fa-check-circle"></i></button>
              <button onclick="annulerCommande('${d.id}')" class="btn-action" style="color:var(--danger)" title="Annuler"><i class="fa-solid fa-times-circle"></i></button>
            </td>
          </tr>
        `;
      });
      document.getElementById("l-select").innerHTML = lOptions;
    }

   // MISE √Ä JOUR DE LA FONCTION FINANCE (Tous les montants)
let paiementChart = null; // Variable globale pour d√©truire/recr√©er le graphique

async function loadFinance() {
    const capSnap = await getDoc(doc(db, "finance", "capital"));
    const capital = capSnap.exists() ? capSnap.data().montant : 0;
    
    const mSnap = await getDocs(collection(db, "mouvements_stock"));
    const dSnap = await getDocs(collection(db, "nouvelles_dettes"));
    const sSnap = await getDocs(collection(db, "stock")); // Pour la valeur du stock

    let caTotal = 0, cash = 0, digital = 0, dettesTotal = 0, valeurStockTotal = 0;
    let debBody = "";

    // 1. Calcul CA et r√©partition Paiements
    mSnap.forEach(docM => {
        const m = docM.data();
        if(m.type === "sortie") {
            const p = peluchesGlobal[m.id_peluche];
            const totalVente = (p?.prix || 0) * m.quantite;
            caTotal += totalVente;
            if(m.paiement === "Cash") cash += totalVente;
            else digital += totalVente;
        }
    });

    // 2. Calcul de la valeur marchande du stock actuel
    sSnap.forEach(docS => {
        const qte = docS.data().quantite || 0;
        const p = peluchesGlobal[docS.id];
        if(p) {
            valeurStockTotal += (p.prix * qte);
        }
    });

    // 3. Gestion des dettes (avec bouton de r√©duction)
    dSnap.forEach(docD => {
        const d = docD.data();
        const idD = docD.id;
        const mnt = parseInt(d.montant);
        dettesTotal += mnt;
        debBody += `<tr><td>${d.nom}</td><td>${d.date_remboursement}</td><td><b>${mnt.toLocaleString()} FCFA</b></td><td><button onclick="gererRemboursement('${idD}', ${mnt}, '${d.nom}')" class="btn-action" style="color:var(--success)"><i class="fa-solid fa-hand-holding-dollar"></i> Recouvrer</button></td></tr>`;
    });

    // --- Affichage des valeurs ---
    document.getElementById("fin-capital-val").textContent = capital.toLocaleString() + " FCFA";
    document.getElementById("fin-ca-total").textContent = caTotal.toLocaleString() + " FCFA";
    document.getElementById("fin-benefice").textContent = (caTotal - capital).toLocaleString() + " FCFA";
    document.getElementById("fin-cash").textContent = cash.toLocaleString() + " FCFA";
    document.getElementById("fin-digital").textContent = digital.toLocaleString() + " FCFA";
    document.getElementById("fin-dettes-total").textContent = dettesTotal.toLocaleString() + " FCFA";
    document.getElementById("fin-valeur-stock").textContent = valeurStockTotal.toLocaleString() + " FCFA";
    document.getElementById("debiteurs-body").innerHTML = debBody || "<tr><td colspan='4'>Aucune dette</td></tr>";

    // --- G√©n√©ration du Diagramme ---
    renderPaiementChart(cash, digital);
}

// Fonction pour dessiner le graphique
function renderPaiementChart(cash, digital) {
    const ctx = document.getElementById('paiementChart').getContext('2d');
    
    if (paiementChart) paiementChart.destroy(); // Nettoyer l'ancien graphique

    paiementChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cash', 'Digital'],
            datasets: [{
                data: [cash, digital],
                backgroundColor: ['#10b981', '#2563eb'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' }
            },
            cutout: '70%'
        }
    });
}

// Nouvelles fonctions ajout√©es
    window.creerDette = async () => {
        const nom = document.getElementById("dette-nom").value;
        const montant = parseInt(document.getElementById("dette-montant").value);
        const date = document.getElementById("dette-date").value;
        if(!nom || !montant || !date) return alert("Remplissez tout le formulaire de dette");
        await addDoc(collection(db, "nouvelles_dettes"), { nom, montant, date_remboursement: date, cree_le: serverTimestamp() });
        alert("Dette enregistr√©e !");
        location.reload();
    };

    async function verifierRemboursements() {
        const today = new Date().toISOString().split('T')[0];
        const snap = await getDocs(query(collection(db, "nouvelles_dettes"), where("date_remboursement", "==", today)));
        const container = document.getElementById("notif-container");
        snap.forEach(d => {
            const data = d.data();
            container.innerHTML += `<div class="notif-alert"><i class="fa-solid fa-bell"></i> üí∞ Rappel : <b>${data.nom}</b> doit rembourser <b>${data.montant} FCFA</b> aujourd'hui !</div>`;
        });
    }

    window.updateCapital = async () => {
        const val = parseInt(document.getElementById("new-cap-input").value);
        if(!val) return alert("Entrez un montant");
        await setDoc(doc(db, "finance", "capital"), { montant: val, date: serverTimestamp() });
        alert("Capital mis √† jour !");
        loadFinance();
    };

    async function loadHistory() {
      const histBody = document.getElementById("history-body");
      histBody.innerHTML = "";
      const q = query(collection(db, "mouvements_stock"), orderBy("date", "desc"));
      const snap = await getDocs(q);

      snap.forEach(d => {
        const m = d.data();
        const p = peluchesGlobal[m.id_peluche];
        const produitNom = p ? `${p.taille}cm ${p.couleur}` : "Inconnu";
        const dateStr = m.date?.toDate().toLocaleString('fr-FR');
        const badge = m.type === 'entree' ? '<span class="badge-in">ENTR√âE</span>' : '<span class="badge-out">SORTIE</span>';
        
        let actions = `<button class="btn-action btn-delete" onclick="deleteMouvement('${d.id}', '${m.type}', '${m.id_peluche}', ${m.quantite})"><i class="fa-solid fa-trash"></i></button>`;
        if(m.type === 'sortie') {
            actions += `<button class="btn-action btn-print" onclick="imprimerRecu('${btoa(JSON.stringify({...m, produit: produitNom, date: dateStr}))}')"><i class="fa-solid fa-receipt"></i></button>`;
        }

        histBody.innerHTML += `
          <tr>
            <td>${badge}</td>
            <td><strong>${produitNom}</strong></td>
            <td>${m.quantite}</td>
            <td>${m.auteur || 'Admin'}</td>
            <td>${dateStr}</td>
            <td>${m.paiement || '-'}</td>
            <td>${actions}</td>
          </tr>
        `;
      });
    }

 async function loadInventory() {
    const sSnap = await getDocs(collection(db, "stock"));
    let totalGlobal = 0;
    let parTaille = {};
    let parCouleur = {};
    let tableData = [];

    sSnap.forEach(d => {
        const idDoc = d.id; // L'ID du document dans la collection stock
        const q = d.data().quantite;
        const p = peluchesGlobal[idDoc];
        if(p) {
            totalGlobal += q;
            parTaille[p.taille] = (parTaille[p.taille] || 0) + q;
            parCouleur[p.couleur] = (parCouleur[p.couleur] || 0) + q;
            tableData.push({ ...p, id: idDoc, quantite: q });
        }
    });

    document.getElementById("inv-total-global").textContent = totalGlobal + " peluches";
    
    let tHtml = "";
    Object.entries(parTaille).sort((a,b) => a[0]-b[0]).forEach(([t, q]) => {
        tHtml += `<div class="inv-card"><span>Taille <strong>${t}cm</strong></span> <span style="font-weight:700">${q}</span></div>`;
    });
    document.getElementById("inv-tailles").innerHTML = tHtml;

    let cHtml = "";
    Object.entries(parCouleur).forEach(([c, q]) => {
        cHtml += `<div class="inv-card"><span>Couleur <strong>${c}</strong></span> <span style="font-weight:700">${q}</span></div>`;
    });
    document.getElementById("inv-couleurs").innerHTML = cHtml;

    const invBody = document.getElementById("inv-table-body");
    invBody.innerHTML = "";
    
    // Tri par taille et g√©n√©ration des lignes du tableau
    tableData.sort((a,b) => a.taille - b.taille).forEach(item => {
        const description = `${item.taille}cm - ${item.couleur}`;
        invBody.innerHTML += `
            <tr>
                <td>${item.taille}cm</td>
                <td>${item.couleur}</td>
                <td><b style="color:${item.quantite <= 5 ? 'var(--danger)' : 'inherit'}">${item.quantite}</b></td>
                <td>${(item.prix || 0).toLocaleString()} FCFA</td>
                <td>
                    <button onclick="modifierQuantiteStock('${item.id}', ${item.quantite}, '${description.replace(/'/g, "\\'")}')" 
                            class="btn-action" style="color:var(--primary-blue)" title="Modifier le stock">
                        <i class="fa-solid fa-pen-to-square"></i> Modifier
                    </button>
                </td>
            </tr>`;
    });
}

// N'oubliez pas d'ajouter la fonction de traitement associ√©e :
window.modifierQuantiteStock = async (id, quantiteActuelle, description) => {
    const nouvelleQuantite = prompt(`Modifier le stock pour : ${description}\nQuantit√© actuelle : ${quantiteActuelle}\nEntrez la nouvelle quantit√© :`, quantiteActuelle);
    
    if (nouvelleQuantite === null) return;
    
    const qteNum = parseInt(nouvelleQuantite);
    if (isNaN(qteNum) || qteNum < 0) {
        alert("Veuillez entrer un nombre valide.");
        return;
    }

    try {
        const stockRef = doc(db, "stock", id);
        await updateDoc(stockRef, { quantite: qteNum });
        alert("Stock mis √† jour avec succ√®s !");
        loadInventory(); // Rafra√Æchissement imm√©diat
    } catch (e) {
        console.error("Erreur mise √† jour stock:", e);
        alert("Erreur lors de la modification.");
    }
};
    window.imprimerRecu = (dataB64) => {
        const m = JSON.parse(atob(dataB64));
        const win = window.open('', '', 'width=400,height=600');
        win.document.write(`
            <div style="font-family:sans-serif; text-align:center; padding:20px; border:1px dashed #000;">
                <h2>PELUCHESTORE</h2>
                <p>Re√ßu de Vente</p>
                <hr>
                <div style="text-align:left;">
                    <p><strong>Date:</strong> ${m.date}</p>
                    <p><strong>Article:</strong> ${m.produit}</p>
                    <p><strong>Qt√©:</strong> ${m.quantite}</p>
                    <p><strong>Paiement:</strong> ${m.paiement || 'Cash'}</p>
                    <p><strong>Vendeur:</strong> ${m.auteur}</p>
                </div>
                <hr>
                <p>Merci de votre confiance !</p>
            </div>
        `);
        win.print();
        win.close();
    };

    window.saveEntree = async () => {
      const id = document.getElementById("p-select-entree").value;
      const qty = parseInt(document.getElementById("p-qty-entree").value);
      if(!id || !qty) return alert("Remplissez tous les champs");
      try {
        const stockRef = doc(db, "stock", id);
        const s = await getDoc(stockRef);
        s.exists() ? await updateDoc(stockRef, { quantite: increment(qty) }) : await setDoc(stockRef, { quantite: qty });
        await addDoc(collection(db, "mouvements_stock"), { id_peluche: id, quantite: qty, type: "entree", date: serverTimestamp(), auteur: userName });
        location.reload();
      } catch(e) { alert(e.message); }
    };

    window.saveSortie = async () => {
      const id = document.getElementById("p-select-sortie").value;
      const qty = parseInt(document.getElementById("p-qty-sortie").value);
      const client = document.getElementById("v-client").value;
      const tel = document.getElementById("v-tel").value;
      if(!id || !qty || !client || !tel) return alert("Champs obligatoires !");
      try {
        const s = await getDoc(doc(db, "stock", id));
        if(!s.exists() || s.data().quantite < qty) return alert("Stock insuffisant !");
        await addDoc(collection(db, "livraisons"), {
          id_peluche: id, quantite: qty, client: client, telephone: tel, quartier: document.getElementById("v-loc").value,
          mode_paiement: document.getElementById("v-pay").value, statut: "en attente", date_commande: serverTimestamp(), auteur: userName
        });
        alert("Commande enregistr√©e !");
        location.reload();
      } catch(e) { alert(e.message); }
    };

    window.validerLivr = async () => {
      const id = document.getElementById("l-select").value;
      if(!id) return alert("S√©lectionnez une livraison");
      await validerLivrSpecifique(id);
    };

    window.validerLivrSpecifique = async (id) => {
      if(!confirm("Confirmer la livraison ?")) return;
      try {
        const lSnap = await getDoc(doc(db, "livraisons", id));
        const l = lSnap.data();
        await updateDoc(doc(db, "stock", l.id_peluche), { quantite: increment(-l.quantite) });
        await addDoc(collection(db, "mouvements_stock"), {
          id_peluche: l.id_peluche, quantite: l.quantite, type: "sortie", date: serverTimestamp(), auteur: userName, paiement: l.mode_paiement
        });
        await updateDoc(doc(db, "livraisons", id), { statut: "livr√©", date_livraison: serverTimestamp() });
        location.reload();
      } catch(e) { alert(e.message); }
    };

    window.annulerCommande = async (id) => {
      if(!confirm("Voulez-vous vraiment annuler cette commande ?")) return;
      try {
        await deleteDoc(doc(db, "livraisons", id));
        location.reload();
      } catch(e) { alert(e.message); }
    };

    window.deleteMouvement = async (docId, type, pId, qty) => {
        if(!confirm("R√©ajuster le stock et supprimer ?")) return;
        const adj = type === 'entree' ? -qty : qty;
        await updateDoc(doc(db, "stock", pId), { quantite: increment(adj) });
        await deleteDoc(doc(db, "mouvements_stock", docId));
        location.reload();
    };

   async function loadMonthlyPerformance() {
    const now = new Date();

    // üîí D√©but et fin EXACTS du mois
    const startOfMonth = Timestamp.fromDate(
        new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0)
    );

    const endOfMonth = Timestamp.fromDate(
        new Date(now.getFullYear(), now.getMonth() + 1, 1, 0, 0, 0)
    );

    // üóìÔ∏è Affichage du mois
    const monthNames = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
    document.getElementById("current-month-display").textContent =
        monthNames[now.getMonth()] + " " + now.getFullYear();

    /* =========================
       CHIFFRE D‚ÄôAFFAIRES DU MOIS
       ========================= */
    const ventesSnap = await getDocs(
        query(
            collection(db, "mouvements_stock"),
            where("type", "==", "sortie"),
            where("date", ">=", startOfMonth),
            where("date", "<", endOfMonth)
        )
    );

    let caMois = 0;
    ventesSnap.forEach(doc => {
        const m = doc.data();
        const prix = peluchesGlobal[m.id_peluche]?.prix || 0;
        caMois += prix * m.quantite;
    });

    /* =========================
       D√âPENSES DU MOIS
       ========================= */
    const depSnap = await getDocs(
        query(
            collection(db, "depenses"),
            where("date", ">=", startOfMonth),
            where("date", "<", endOfMonth)
        )
    );

    let totalDepMois = 0;
    const depStats = {};

    depSnap.forEach(doc => {
        const d = doc.data();
        totalDepMois += d.montant;
        depStats[d.nom] = (depStats[d.nom] || 0) + d.montant;
    });

    /* =========================
       AFFICHAGE DES CHIFFRES
       ========================= */
    document.getElementById("perf-ca-mois").textContent =
        caMois.toLocaleString() + " FCFA";

    document.getElementById("perf-dep-mois").textContent =
        totalDepMois.toLocaleString() + " FCFA";

    document.getElementById("perf-marge-mois").textContent =
        (caMois - totalDepMois).toLocaleString() + " FCFA";

    /* =========================
       GRAPHIQUE : R√âPARTITION
       ========================= */
    const ctx1 = document.getElementById("depTypeChart");
    if (Chart.getChart(ctx1)) Chart.getChart(ctx1).destroy();

    new Chart(ctx1, {
        type: "doughnut",
        data: {
            labels: Object.keys(depStats),
            datasets: [{
                data: Object.values(depStats)
            }]
        }
    });

    /* =========================
       GRAPHIQUE : SANT√â FINANCI√àRE
       ========================= */
    const ctx2 = document.getElementById("healthChart");
    if (Chart.getChart(ctx2)) Chart.getChart(ctx2).destroy();

    new Chart(ctx2, {
        type: "bar",
        data: {
            labels: ["Mois en cours"],
            datasets: [
                { label: "Revenus", data: [caMois] },
                { label: "D√©penses", data: [totalDepMois] }
            ]
        },
        options: { responsive: true }
    });
}

    function renderCharts(mvts, livrs, pMap) {
      const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
      const salesData = new Array(12).fill(0);
      mvts.forEach(m => {
        const d = m.date?.toDate();
        if(m.type === "sortie" && d) salesData[d.getMonth()] += (pMap[m.id_peluche]?.prix || 0) * m.quantite;
      });
      const ids = ['salesChart', 'modelChart', 'inOutChart'];
      ids.forEach(id => { const c = Chart.getChart(id); if(c) c.destroy(); });
      new Chart(document.getElementById('salesChart'), { type: 'line', data: { labels: months, datasets: [{ label: 'Ventes (FCFA)', data: salesData, borderColor: '#2563eb', tension: 0.3 }] } });
      const mSales = {};
      mvts.filter(m => m.type === "sortie").forEach(m => {
        const n = pMap[m.id_peluche] ? `${pMap[m.id_peluche].taille}cm ${pMap[m.id_peluche].couleur}` : "Inconnu";
        mSales[n] = (mSales[n] || 0) + m.quantite;
      });
      new Chart(document.getElementById('modelChart'), { type: 'bar', data: { labels: Object.keys(mSales), datasets: [{ data: Object.values(mSales), backgroundColor: '#3b82f6' }] }, options: { indexAxis: 'y' } });
      let iQ = 0, oQ = 0; mvts.forEach(m => { if(m.type === "entree") iQ += m.quantite; else oQ += m.quantite; });
      new Chart(document.getElementById('inOutChart'), { type: 'bar', data: { labels: ['E', 'S'], datasets: [{ data: [iQ, oQ], backgroundColor: ['#10b981', '#ef4444'] }] } });
    }

    // Affiche le champ "Autre" si n√©cessaire
window.toggleAutreDepense = () => {
    const type = document.getElementById("dep-type").value;
    document.getElementById("group-autre").style.display = (type === "autre") ? "block" : "none";
};

// Enregistrer la d√©pense
window.saveDepense = async () => {
    const type = document.getElementById("dep-type").value;
    const autreNom = document.getElementById("dep-autre-nom").value;
    const montant = parseInt(document.getElementById("dep-montant").value);
    
    const finalNom = (type === "autre") ? autreNom : type;

    if(!finalNom || !montant) return alert("Veuillez remplir tous les champs");

    try {
        await addDoc(collection(db, "depenses"), {
            nom: finalNom,
            montant: montant,
            auteur: userName,
            date: serverTimestamp()
        });
        alert("D√©pense enregistr√©e !");
        document.getElementById("dep-type").value = "";
        document.getElementById("dep-autre-nom").value = "";
        document.getElementById("dep-montant").value = "";
        loadDepenses();
    } catch(e) { alert(e.message); }
};

// Charger les d√©penses et le graphique
async function loadDepenses() {
    const q = query(collection(db, "depenses"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    const body = document.getElementById("depenses-body");
    body.innerHTML = "";

    const monthlyData = new Array(12).fill(0);
    const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];

    snap.forEach(docD => {
        const d = docD.data();
        const dt = d.date?.toDate();
        if(dt) monthlyData[dt.getMonth()] += d.montant;

        body.innerHTML += `
            <tr>
                <td><strong>${d.nom}</strong></td>
                <td><b style="color:var(--danger)">${d.montant.toLocaleString()} FCFA</b></td>
                <td>${d.auteur}</td>
                <td>${dt ? dt.toLocaleString('fr-FR') : '-'}</td>
            </tr>`;
    });

    // Rendu du graphique des d√©penses
    const ctx = document.getElementById('depChart');
    if(Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{ label: 'D√©penses (FCFA)', data: monthlyData, backgroundColor: '#ef4444' }]
        }
    });
}

    // FONCTION POUR LE SON ET LES ALERTES
    async function verifierDettesEtSon() {
        const today = new Date().toISOString().split('T')[0];
        const snap = await getDocs(query(collection(db, "nouvelles_dettes"), where("date_remboursement", "<=", today)));
        const container = document.getElementById("notif-container");
        
        if (!snap.empty) {
            // √âmission du signal sonore
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);

            snap.forEach(d => {
                const data = d.data();
                container.innerHTML += `<div class="notif-alert"><i class="fa-solid fa-bell"></i> <b>${data.nom}</b> doit rembourser <b>${data.montant.toLocaleString()} FCFA</b> !</div>`;
            });
        }
    }

   window.showSection = function(id) {
    // 1. Cacher tout
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    
    // 2. Afficher la section
    const target = document.getElementById(id);
    if(target) target.classList.add('active');

    // 3. Bouton actif
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
    if(event && event.currentTarget) event.currentTarget.classList.add('active-nav');

    // 4. Si performance, on lance le chargement avec un d√©lai de s√©curit√©
    if(id === 'section-performance') {
        setTimeout(() => {
            loadMonthlyPerformance();
        }, 200);
    }
};

    // Initialisation du s√©lecteur sur le mois actuel
document.getElementById('perf-month-picker').value = new Date().toISOString().slice(0, 7);

document.addEventListener('DOMContentLoaded', () => {
    if(document.getElementById('perf-month-picker')) {
        document.getElementById('perf-month-picker').value = new Date().toISOString().slice(0, 7);
    }
});

window.changeMonth = (delta) => {
    let picker = document.getElementById('perf-month-picker');
    let date = new Date(picker.value + "-01");
    date.setMonth(date.getMonth() + delta);
    picker.value = date.toISOString().slice(0, 7);
    loadMonthlyPerformance();
};

window.loadMonthlyPerformance = async () => {
    const picker = document.getElementById('perf-month-picker');
    if (!picker || !picker.value) return;

    const selectedDate = new Date(picker.value + "-01");
    const now = new Date();
    
    // Dates de d√©but et fin
    const startM = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
    const endM = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0, 23, 59, 59);
    const startPrev = new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 1, 1);
    const endPrev = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 0, 23, 59, 59);

    // Affichage texte du mois
    const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    document.getElementById("current-month-display").textContent = monthNames[selectedDate.getMonth()] + " " + selectedDate.getFullYear();

    try {
        // 1. R√©cup√©ration des donn√©es
        const [mSnap, depSnap, prevMSnap, prevDepSnap] = await Promise.all([
            getDocs(query(collection(db, "mouvements_stock"), where("type", "==", "sortie"), where("date", ">=", startM), where("date", "<=", endM))),
            getDocs(query(collection(db, "depenses"), where("date", ">=", startM), where("date", "<=", endM))),
            getDocs(query(collection(db, "mouvements_stock"), where("type", "==", "sortie"), where("date", ">=", startPrev), where("date", "<=", endPrev))),
            getDocs(query(collection(db, "depenses"), where("date", ">=", startPrev), where("date", "<=", endPrev)))
        ]);

        // 2. Traitement des donn√©es actuelles
        let ca = 0, nbV = 0, payData = {}, sizeData = {}, colorData = {}, topPeluches = {};
        
        mSnap.forEach(docM => {
            const m = docM.data();
            const p = peluchesGlobal[m.id_peluche] || {};
            const montantVente = (p.prix || 0) * m.quantite;
            ca += montantVente;
            nbV += m.quantite;
            
            // Stats par paiement/taille/couleur
            payData[m.paiement] = (payData[m.paiement] || 0) + montantVente;
            if(p.taille) sizeData[p.taille] = (sizeData[p.taille] || 0) + m.quantite;
            if(p.couleur) colorData[p.couleur] = (colorData[p.couleur] || 0) + m.quantite;
            
            const pKey = `${p.nom || 'Inconnu'} (${p.taille || '?'})`;
            topPeluches[pKey] = (topPeluches[pKey] || 0) + m.quantite;
        });

        let dep = 0;
        depSnap.forEach(docD => dep += (docD.data().montant || 0));

        // 3. Traitement mois pr√©c√©dent
        let caPrev = 0, depPrev = 0;
        prevMSnap.forEach(docM => caPrev += (peluchesGlobal[docM.data().id_peluche]?.prix || 0) * docM.data().quantite);
        prevDepSnap.forEach(docD => depPrev += (docD.data().montant || 0));

        // 4. Mise √† jour des KPIs
        const formatVar = (act, prev) => {
            if(!prev) return "N/A";
            const diff = ((act - prev) / prev * 100).toFixed(1);
            return (diff > 0 ? "+" : "") + diff + "%";
        };

        document.getElementById("p-ca").textContent = ca.toLocaleString() + " FCFA";
        document.getElementById("p-ca-var").textContent = "Vs mois pr√©c: " + formatVar(ca, caPrev);
        document.getElementById("p-dep").textContent = dep.toLocaleString() + " FCFA";
        document.getElementById("p-dep-var").textContent = "Vs mois pr√©c: " + formatVar(dep, depPrev);
        document.getElementById("p-marge").textContent = (ca - dep).toLocaleString() + " FCFA";
        document.getElementById("p-nb-ventes").textContent = nbV + " ventes";
        document.getElementById("p-ticket").textContent = "Ticket moyen: " + (nbV > 0 ? Math.round(ca/nbV).toLocaleString() : 0) + " FCFA";

        document.getElementById("p-ca").textContent = ca.toLocaleString() + " FCFA";
    document.getElementById("p-dep").textContent = dep.toLocaleString() + " FCFA";
    document.getElementById("p-marge").textContent = (ca - dep).toLocaleString() + " FCFA";

        // 5. Top 5
        const sortedTop = Object.entries(topPeluches).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById("p-top-5").innerHTML = sortedTop.length ? sortedTop.map(([name, qty]) => 
            `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f3f4f6;">
                <span>${name}</span> <strong>${qty}</strong>
            </div>`).join('') : "Aucune vente";

        // 6. Alertes
        const alerts = document.getElementById("perf-alerts");
        alerts.innerHTML = "";
        if(ca < caPrev && caPrev > 0) alerts.innerHTML += `<div style="background:#fef2f2; color:#b91c1c; padding:12px; border-radius:8px; margin-bottom:15px; border-left:4px solid #ef4444;"><i class="fa-solid fa-circle-exclamation"></i> Le chiffre d'affaires a baiss√© par rapport au mois dernier.</div>`;

        // 7. Graphiques (avec s√©curit√© individuelle)
        setTimeout(() => {
            renderPerfChart('p-pay-chart', 'doughnut', Object.keys(payData), Object.values(payData), ['#10b981', '#3b82f6', '#f59e0b']);
            renderPerfChart('p-size-chart', 'bar', Object.keys(sizeData), Object.values(sizeData), '#6366f1');
            renderPerfChart('p-color-chart', 'pie', Object.keys(colorData), Object.values(colorData), ['#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']);
        }, 300);

    } catch (error) {
        console.error("Erreur Performance:", error);
    }
};
// Fonction de rendu ultra-robuste
function renderPerfChart(id, type, labels, data, colors) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    
    // Si le canvas n'est pas encore visible (largeur 0), on n'essaie pas de dessiner
    if (canvas.clientWidth === 0) return;

    try {
        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        new Chart(canvas, {
            type: type,
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: colors, borderRadius: 5 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } }
            }
        });
    } catch (e) {
        console.warn(`Erreur sur le graphique ${id}:`, e);
    }
}
    window.seDeconnecter = () => signOut(auth).then(() => window.location.href = "index.html");
  </script>
</head>
<body>
  <nav>
    <div class="nav-logo"><img src="lo.jpeg" alt="Logo" style="width: 40px; height: 40px; border-radius: 8px;"><span>PelucheStore</span></div>
    <button class="active-nav" onclick="showSection('section-home')"><i class="fa-solid fa-house"></i> Accueil</button>
    <button onclick="showSection('section-action')"><i class="fa-solid fa-store"></i> Action</button>
    <button onclick="showSection('section-commandes')" id="btn-commandes"><i class="fa-solid fa-cart-shopping"></i> Commandes <span id="badge-commandes" class="badge" style="display:none; background:var(--danger); color:white; border-radius:50%; padding:2px 6px; font-size:10px; margin-left:5px;">0</span></button>
    <button onclick="showSection('section-depenses')"><i class="fa-solid fa-file-invoice-dollar"></i> D√©penses</button>
    <button onclick="showSection('section-reports')"><i class="fa-solid fa-chart-simple"></i> Rapports</button>
    <button onclick="showSection('section-inventory')"><i class="fa-solid fa-warehouse"></i> Inventaire</button>
    <button onclick="showSection('section-finance')"><i class="fa-solid fa-wallet"></i> Finance</button>
    <button onclick="showSection('section-performance')"><i class="fa-solid fa-chart-line"></i> Performance</button>
    <div style="margin-top: auto; padding-bottom: 20px;"><button onclick="seDeconnecter()" style="color:#f87171"><i class="fa-solid fa-power-off"></i> D√©connexion</button></div>
  </nav>

  <div class="main-container">
    <div class="top-bar">
      <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Recherche ..."></div>
      <div class="user-info"><span id="user-name-display">...</span><img id="user-photo" src="" width="35" style="border-radius:50%"></div>
    </div>

    <main>
      <div id="notif-container" style="margin-top:20px"></div>

      <div class="welcome-card">
        <div style="background:#f9fafb; padding:15px; border-radius:10px;"><i class="fa-solid fa-building-user fa-2xl"></i></div>
        <div><div id="welcome-name" style="font-weight:700; font-size:18px;">...</div><div style="color:var(--text-gray); font-size:14px">PelucheStore</div></div>
      </div>

      <section id="section-commandes" class="section" style="display:none;">
    <div class="header-flex">
        <h2><i class="fa-solid fa-bell"></i> Commandes de la Vitrine</h2>
    </div>
    
    <div class="action-card">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Produit Demand√©</th>
                    <th>Statut Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="commandes-vitrine-body"></tbody>
        </table>
    </div>
</section>

      <section id="section-home" class="section active">
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
          <div>
            <div style="display: flex; gap: 15px;">
              <div class="stat-box"><div class="count" id="ventes-mois">0</div><div class="label">Ventes mois</div></div>
              <div class="stat-box"><div class="count" id="livr-attente" style="color: #ef4444;">0</div><div class="label">Attente</div></div>
              <div class="stat-box"><div class="count" id="livr-jour" style="color: #10b981;">0</div><div class="label">Livr√©es jour</div></div>
            </div>
          </div>
          <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #eef2f6;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0;"><span>Total Stock</span><span id="stock-total" style="font-weight: 800;">0</span></div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;"><span>Alertes</span><span id="stock-alerte" style="font-weight: 800; color:#ef4444;">0</span></div>
          </div>
        </div>
        <div class="charts-grid">
          <div class="chart-container full-width-chart"><canvas id="salesChart" height="80"></canvas></div>
          <div class="chart-container"><canvas id="modelChart"></canvas></div>
          <div class="chart-container"><canvas id="inOutChart"></canvas></div>
        </div>
        <div id="details-alerte-stock" class="action-card" style="display: none; margin-top: 20px; border-left: 4px solid var(--danger);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3 style="margin:0; color: var(--danger);"><i class="fa-solid fa-triangle-exclamation"></i> Peluches en rupture de stock (< 15)</h3>
              <button onclick="document.getElementById('details-alerte-stock').style.display='none'" style="border:none; background:none; cursor:pointer; color:var(--text-gray);"><i class="fa-solid fa-xmark fa-xl"></i></button>
          </div>
          <table class="history-table">
              <thead>
                  <tr>
                      <th>Article</th>
                      <th>Taille</th>
                      <th>Couleur</th>
                      <th style="color: var(--danger);">Stock Restant</th>
                  </tr>
              </thead>
              <tbody id="alerte-stock-body"></tbody>
          </table>
      </div>
      </section>

      <section id="section-depenses" class="section">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
        <div class="action-card">
            <h3><i class="fa-solid fa-plus-circle"></i> Nouvelle D√©pense</h3>
            <div class="form-group">
                <label>Type de d√©pense</label>
                <select id="dep-type" onchange="toggleAutreDepense()">
                    <option value="">-- Choisir --</option>
                    <option value="Loyer">Loyer</option>
                    <option value="Connexion">Connexion</option>
                    <option value="Courses">Courses</option>
                    <option value="Salaire">Salaire</option>
                    <option value="Coton">Coton</option>
                    <option value="Transport">Transport</option>
                    <option value="Achat Peluches">Achat Peluches</option>
                    <option value="Cotisation">Cotisation</option>
                    <option value="Electricite">Electricite</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div id="group-autre" class="form-group" style="display:none;">
                <label>Nom de la d√©pense</label>
                <input type="text" id="dep-autre-nom" placeholder="Pr√©cisez...">
            </div>
            <div class="form-group">
                <label>Montant (FCFA)</label>
                <input type="number" id="dep-montant" placeholder="0">
            </div>
            <button onclick="saveDepense()" class="btn-submit" style="background:var(--danger)">Enregistrer</button>
        </div>

        <div class="chart-container">
            <h3>√âvolution des d√©penses mensuelles</h3>
            <canvas id="depChart" height="150"></canvas>
        </div>
    </div>

    <div class="action-card" style="margin-top:20px;">
        <h3><i class="fa-solid fa-list-ul"></i> Historique des d√©penses</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>D√©pense</th>
                    <th>Montant</th>
                    <th>Par</th>
                    <th>Date & Heure</th>
                </tr>
            </thead>
            <tbody id="depenses-body"></tbody>
        </table>
    </div>
</section>

<section id="section-performance" class="section">
    <div class="welcome-card" style="justify-content: space-between; background: var(--sidebar-bg); color: white;">
        <div>
            <h2 style="margin:0;">Analyse Mensuelle</h2>
            <span id="current-month-display" style="opacity: 0.8;">Chargement...</span>
        </div>
    </div>

    <div class="fin-summary">
        <div class="fin-card" style="background: #2563eb;">
            <span>Ventes du mois</span>
            <span id="perf-ca-mois">0 FCFA</span>
        </div>
        <div class="fin-card" style="background: #ef4444;">
            <span>D√©penses du mois</span>
            <span id="perf-dep-mois">0 FCFA</span>
        </div>
        <div class="fin-card" style="background: #10b981;">
            <span>Marge Nette</span>
            <span id="perf-marge-mois">0 FCFA</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>R√©partition des D√©penses</h3>
            <canvas id="depTypeChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Sant√© Financi√®re (Revenus vs D√©penses)</h3>
            <canvas id="healthChart"></canvas>
        </div>
    </div>
</section>

      <section id="section-action" class="section">
        <div class="action-grid">
          <div class="action-card">
            <h3><i class="fa-solid fa-box-open" style="color:#10b981"></i> Entr√©e Stock</h3>
            <div class="form-group"><label>Peluche</label><select id="p-select-entree"></select></div>
            <div class="form-group"><label>Qt√©</label><input type="number" id="p-qty-entree"></div>
            <button onclick="saveEntree()" class="btn-submit" style="background:#10b981">Ajouter</button>
          </div>
          <div class="action-card">
            <h3><i class="fa-solid fa-cart-shopping" style="color:#2563eb"></i> Vente</h3>
            <div class="form-group"><label>Client*</label><input type="text" id="v-client"></div>
            <div class="form-group"><label>Tel*</label><input type="text" id="v-tel"></div>
            <div class="form-group"><label>Loc</label><input type="text" id="v-loc"></div>
            <div class="form-group"><label>Peluche*</label><select id="p-select-sortie"></select></div>
            <div class="form-group"><label>Qt√©*</label><input type="number" id="p-qty-sortie"></div>
            <div class="form-group"><label>Paiement</label>
                <select id="v-pay">
                    <option>Cash</option>
                    <option>Orange Money</option>
                    <option>MTN Momo</option>
                </select>
            </div>
            <button onclick="saveSortie()" class="btn-submit" style="background:#2563eb">Commander</button>
          </div>
          <div class="action-card">
            <h3><i class="fa-solid fa-truck-fast" style="color:#f59e0b"></i> Livraison rapide</h3>
            <div class="form-group"><label>S√©lectionner</label><select id="l-select"></select></div>
            <button onclick="validerLivr()" class="btn-submit" style="background:#f59e0b; margin-top:20px;">Valider Livraison</button>
          </div>
        </div>

        <div class="action-card" style="grid-column: span 3; margin-top: 20px;">
          <h3><i class="fa-solid fa-clock" style="color:#f59e0b"></i> Commandes √† livrer</h3>
          <table class="history-table">
            <thead>
              <tr>
                <th>Client</th>
                <th>Article</th>
                <th>Qt√©</th>
                <th>Lieu</th>
                <th>Paiement</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="pending-orders-body"></tbody>
          </table>
        </div>
      </section>

      <section id="section-finance" class="section">
    <div class="fin-summary">
        <div class="fin-card" style="background: #111827;"><span>Capital</span><span id="fin-capital-val">0 FCFA</span></div>
        <div class="fin-card" style="background: #2563eb;"><span>Chiffre Affaires</span><span id="fin-ca-total">0 FCFA</span></div>
        <div class="fin-card" style="background: #10b981;"><span>B√©n√©fice</span><span id="fin-benefice">0 FCFA</span></div>
    </div>
    <div class="fin-summary">
        <div class="fin-card" style="background: #f59e0b;"><span>Dettes Total</span><span id="fin-dettes-total">0 FCFA</span></div>
        <div class="fin-card" style="background: #4b5563;"><span>Ventes Cash</span><span id="fin-cash">0 FCFA</span></div>
        <div class="fin-card" style="background: #8b5cf6;"><span>Ventes Digital</span><span id="fin-digital">0 FCFA</span></div>
    </div>
    <div class="action-grid" style="margin-top:20px">
    <div class="action-card">
        <h3><i class="fa-solid fa-hand-holding-dollar" style="color:var(--danger)"></i> Ajouter une Dette</h3>
        <div class="form-group">
            <label>Nom du d√©biteur</label>
            <input type="text" id="dette-nom" placeholder="Ex: Jean Paul">
        </div>
        <div class="form-group">
            <label>Montant (FCFA)</label>
            <input type="number" id="dette-montant" placeholder="0">
        </div>
        <div class="form-group">
            <label>Date de remboursement</label>
            <input type="date" id="dette-date">
        </div>
        <button onclick="creerDette()" class="btn-submit" style="background:var(--danger)">Enregistrer la dette</button>
    </div>

    <div class="action-card">
        <h3><i class="fa-solid fa-pen-to-square" style="color:var(--sidebar-bg)"></i> Modifier le Capital</h3>
        <div class="form-group">
            <label>Nouveau montant du Capital</label>
            <input type="number" id="new-cap-input" placeholder="Entrez le montant total">
        </div>
        <p style="font-size: 11px; color: var(--text-gray);">Note : Cela √©crasera la valeur actuelle du capital dans la base de donn√©es.</p>
        <button onclick="updateCapital()" class="btn-submit" style="background:var(--sidebar-bg)">Mettre √† jour le capital</button>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px;">
    <div class="stat-card" style="border-left: 5px solid var(--primary-blue);">
        <i class="fa-solid fa-boxes-stacked" style="font-size: 24px; color: var(--primary-blue);"></i>
        <div style="margin-top: 10px;">
            <span style="color: var(--text-gray); font-size: 14px;">Valeur Totale du Stock</span>
            <h2 id="fin-valeur-stock" style="margin: 5px 0; font-size: 24px;">0 FCFA</h2>
        </div>
    </div>

    <div class="action-card" style="padding: 15px;">
        <h3 style="margin-bottom: 15px; font-size: 16px;"><i class="fa-solid fa-chart-pie"></i> Modes de Paiement</h3>
        <canvas id="paiementChart" style="max-height: 200px;"></canvas>
    </div>
</div>


    <div class="action-card" style="margin-top:20px;">
        <h3><i class="fa-solid fa-list"></i> Liste compl√®te des dettes</h3>
        <table class="history-table">
            <thead><tr><th>Nom</th><th>√âch√©ance</th><th>Montant</th><th>Action</th></tr></thead>
            <tbody id="debiteurs-body"></tbody>
        </table>
    </div>
</section>

      <section id="section-reports" class="section">
        <h3>Historique des Mouvements</h3>
        <table class="history-table">
          <thead><tr><th>Type</th><th>Article</th><th>Qt√©</th><th>Par</th><th>Date</th><th>Paiement</th><th>Actions</th></tr></thead>
          <tbody id="history-body"></tbody>
        </table>
      </section>

      <section id="section-inventory" class="section">
        <h3>Inventaire Global</h3>
        <div class="inv-card" style="background: var(--primary-blue); color: white; border: none; margin-bottom: 25px;">
            <span style="font-size: 18px; font-weight: 600;">Stock Actuel</span>
            <span id="inv-total-global" style="font-size: 24px; font-weight: 800;">0</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div><h4 style="color:var(--text-gray)"><i class="fa-solid fa-ruler"></i> Par Taille</h4><div id="inv-tailles"></div></div>
            <div><h4 style="color:var(--text-gray)"><i class="fa-solid fa-palette"></i> Par Couleur</h4><div id="inv-couleurs"></div></div>
        </div>

        <h4><i class="fa-solid fa-list-check"></i> Tableau de Stock (Tri√© par Taille)</h4>
        <table class="history-table">
            <thead><tr><th>Taille</th><th>Couleur</th><th>Quantit√©</th><th>Prix Unitaire</th><th>Action</th></tr></thead>
            <tbody id="inv-table-body"></tbody>
        </table>
      </section>
    </main>
  </div>
</body>
</html>
